<script>
    const USE_BACKEND = true;
    const API_ENDPOINT = '/.netlify/functions/lastfm';

    // Generic function to talk to backend
    async function fetchLastFM(params) {
        const query = new URLSearchParams(params).toString();
        const res = await fetch(`${API_ENDPOINT}?${query}`);
        return await res.json();
    }

    async function calculateListeningAge() {
        const username = document.getElementById('username').value.trim();
        if (!username) {
            showError('Please enter your Last.fm username');
            return;
        }

        document.getElementById('calculate').disabled = true;
        document.getElementById('loading').style.display = 'block';
        document.getElementById('error').style.display = 'none';
        document.getElementById('results').style.display = 'none';
        document.getElementById('progress').textContent = '';

        try {
            updateProgress('Fetching your top albums...');
            const topAlbums = await fetchTopAlbums(username);

            if (!topAlbums || topAlbums.length === 0) {
                throw new Error('No albums found. Check your username.');
            }

            updateProgress(`Found ${topAlbums.length} albums! Getting release dates...`);
            const albumsWithDates = await fetchAlbumDates(topAlbums, username);

            if (albumsWithDates.length === 0) {
                throw new Error('Not enough release date info.');
            }

            updateProgress('Calculating...');
            const analysis = analyzeListeningAge(albumsWithDates);
            displayResults(analysis);

        } catch (error) {
            showError(error.message);
        } finally {
            document.getElementById('calculate').disabled = false;
            document.getElementById('loading').style.display = 'none';
        }
    }

    function updateProgress(msg) {
        document.getElementById('progress').textContent = msg;
    }

    // NEW fetchTopAlbums using backend
    async function fetchTopAlbums(username) {
        const data = await fetchLastFM({
            method: "user.gettopalbums",
            user: username,
            limit: 100,
            period: "overall"
        });

        if (data.error) throw new Error(data.message);
        return data.topalbums?.album || [];
    }

    // NEW fetchAlbumDates using backend
    async function fetchAlbumDates(albums, username) {
        const out = [];
        const max = Math.min(albums.length, 40);

        for (let i = 0; i < max; i++) {
            const album = albums[i];
            updateProgress(`Analyzing album ${i + 1}/${max}...`);

            const data = await fetchLastFM({
                method: "album.getinfo",
                artist: album.artist.name,
                album: album.name,
                username
            });

            let year = null;

            if (data.album?.wiki?.published) {
                year = new Date(data.album.wiki.published).getFullYear();
            }

            if (year && year >= 1950 && year <= new Date().getFullYear()) {
                out.push({
                    name: album.name,
                    artist: album.artist.name,
                    playcount: parseInt(album.playcount),
                    year
                });
            }

            await new Promise(res => setTimeout(res, 150));
        }

        return out;
    }

    // Analyze + Display remain unchanged
    function analyzeListeningAge(albums) {
        const decadeCounts = {};
        const currentYear = new Date().getFullYear();

        albums.forEach(a => {
            const decade = Math.floor(a.year / 10) * 10;
            decadeCounts[decade] = decadeCounts[decade] || { count: 0, playcount: 0 };
            decadeCounts[decade].count++;
            decadeCounts[decade].playcount += a.playcount;
        });

        let bestDecade = null, bestScore = 0;

        for (const [decade, d] of Object.entries(decadeCounts)) {
            const score = d.count * Math.log(d.playcount + 1);
            if (score > bestScore) {
                bestScore = score;
                bestDecade = parseInt(decade);
            }
        }

        const listeningAge = currentYear - (bestDecade + 5);

        return {
            listeningAge,
            dominantDecade: bestDecade,
            totalAlbums: albums.length,
            decadeDistribution: decadeCounts,
            averageYear: Math.round(albums.reduce((s, a) => s + a.year, 0) / albums.length)
        };
    }

    function displayResults(a) {
        const resultsDiv = document.getElementById('results');

        const decades = Object.keys(a.decadeDistribution).sort();
        const max = Math.max(...Object.values(a.decadeDistribution).map(x => x.count));

        let bars = '';
        decades.forEach(decade => {
            const d = a.decadeDistribution[decade];
            const pct = (d.count / max) * 100;
            const crown = parseInt(decade) === a.dominantDecade ? 'ðŸ‘‘' : '';

            bars += `
                <div class="decade-bar">
                    <div class="decade-name">${decade}s</div>
                    <div class="bar-container">
                        <div class="bar-fill"
