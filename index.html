<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Listening Age Calculator</title>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 600px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2em;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }

        .input-group { margin-bottom: 20px; }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }

        input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }

        .loading {
            text-align: center;
            margin-top: 20px;
            color: #667eea;
        }

        .progress { margin-top: 10px; font-size: 0.9em; color: #666; }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }

        .results { margin-top: 30px; display: none; animation: fadeIn 0.5s; }

        .listening-age {
            text-align: center;
            padding: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .age-number { font-size: 4em; font-weight: bold; margin: 10px 0; }

        .stats { display: grid; gap: 15px; }

        .stat-card { background: #f5f5f5; padding: 15px; border-radius: 8px; }

        .stat-label { color: #666; font-size: 0.9em; margin-bottom: 5px; }

        .stat-value { font-size: 1.2em; font-weight: 600; }

        .decade-bar { display: flex; justify-content: space-between; margin-bottom: 8px; }

        .decade-name { width: 80px; }

        .bar-container {
            flex: 1;
            height: 24px;
            background: #e0e0e0;
            border-radius: 12px;
            overflow: hidden;
            margin: 0 10px;
        }

        .bar-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: width 0.5s ease;
        }
    </style>
</head>

<body>
<div class="container">
    <h1>ðŸŽµ Listening Age Calculator</h1>
    <p class="subtitle">Discover your musical era based on your Last.fm listening history</p>

    <div class="input-group">
        <label for="username">Last.fm Username</label>
        <input type="text" id="username" placeholder="Enter your Last.fm username">
    </div>

    <button id="calculate" onclick="calculateListeningAge()">Calculate My Listening Age</button>

    <div id="loading" class="loading" style="display:none;">
        <p>Analyzing your music taste...</p>
        <div class="progress" id="progress"></div>
    </div>

    <div id="error" class="error"></div>
    <div id="results" class="results"></div>
</div>

<script>
const API_ENDPOINT = '/.netlify/functions/lastfm';

function updateProgress(msg) {
    document.getElementById('progress').textContent = msg;
}

async function fetchLastFM(params) {
    const query = new URLSearchParams(params).toString();
    const res = await fetch(`${API_ENDPOINT}?${query}`);
    return await res.json();
}

async function fetchMusicBrainz(artist, album) {
    const q = encodeURIComponent(`artist:"${artist}" AND release:"${album}"`);
    const url = `https://musicbrainz.org/ws/2/release-group?query=${q}&fmt=json`;

    try {
        const res = await fetch(url, { headers: { 'User-Agent': 'ListeningAge/1.0' } });
        const data = await res.json();
        const groups = data["release-groups"];
        if (!groups || groups.length === 0) return null;

        let best = null;
        for (const g of groups) {
            if (g["first-release-date"]) {
                const y = parseInt(g["first-release-date"].slice(0,4));
                if (!best || y < best) best = y;
            }
        }
        return best || null;
    } catch { return null; }
}

function inferYearFromTags(tags) {
    if (!tags) return null;
    const t = tags.map(x => x.name.toLowerCase());

    const map = {
        "50s":1950,"60s":1960,"70s":1970,"80s":1980,
        "90s":1990,"00s":2000,"2000s":2000,
        "10s":2010,"2010s":2010,"20s":2020,"2020s":2020
    };
    for (const tag of t) {
        for (const key in map) {
            if (tag.includes(key)) return map[key];
        }
    }
    return null;
}

async function resolveAlbumYear(album, username, i, total) {
    const artist = album.artist.name;
    const name = album.name;

    updateProgress(`Resolving ${i}/${total}: ${artist} â€” ${name}`);

    try {
        const data = await fetchLastFM({
            method: "album.getinfo", artist, album: name, username
        });

        if (data?.album?.wiki?.published) {
            const y = new Date(data.album.wiki.published).getFullYear();
            if (!isNaN(y)) return y;
        }

        const tagYear = inferYearFromTags(data?.album?.tags?.tag);
        if (tagYear) return tagYear;
    } catch {}

    try {
        const track = await fetchLastFM({
            method:"track.getinfo", artist, track:name, username
        });
        if (track?.track?.wiki?.published) {
            const y = new Date(track.track.wiki.published).getFullYear();
            if (!isNaN(y)) return y;
        }
    } catch {}

    const mb = await fetchMusicBrainz(artist, name);
    if (mb) return mb;

    return null;
}

async function fetchTopAlbums(username) {
    const data = await fetchLastFM({
        method: "user.gettopalbums", user: username, limit: 100, period:"overall"
    });
    return data.topalbums?.album || [];
}

async function fetchAlbumDates(albums, username) {
    const out = [];
    const total = Math.min(albums.length, 100);

    for (let i = 0; i < total; i++) {
        const year = await resolveAlbumYear(albums[i], username, i+1, total);

        if (year && year >= 1950 && year <= new Date().getFullYear()) {
            out.push({
                name: albums[i].name,
                artist: albums[i].artist.name,
                playcount: parseInt(albums[i].playcount) || 1,
                year
            });
        }

        await new Promise(r => setTimeout(r, 120));
    }

    return out;
}

function analyzeListeningAge(albums) {
    const weights = albums.map(a => a.playcount);
    const totalWeight = weights.reduce((a,b)=>a+b,0);

    const weightedMean =
        albums.reduce((s,a)=>s + a.year*(a.playcount),0) / totalWeight;

    const expanded = [];
    for (const a of albums) {
        expanded.push(...Array(Math.max(1,Math.floor(a.playcount/5))).fill(a.year));
    }
    const weightedMedian = expanded[Math.floor(expanded.length/2)];

    const decadeBuckets = {};
    for (const a of albums) {
        const d = Math.floor(a.year/10)*10;
        decadeBuckets[d] = (decadeBuckets[d]||0) + a.playcount;
    }

    let bestDecade = null, max = -1;
    for (const d in decadeBuckets) {
        if (decadeBuckets[d] > max) {
            max = decadeBuckets[d];
            bestDecade = parseInt(d);
        }
    }

    const finalYear =
          weightedMean * 0.45
        + weightedMedian * 0.35
        + (bestDecade+5) * 0.20;

    const current = new Date().getFullYear();
    return {
        listeningAge: current - Math.round(finalYear),
        dominantDecade: Math.floor(finalYear/10)*10,
        totalAlbums: albums.length,
        averageYear: Math.round(weightedMean),
        decadeDistribution: decadeBuckets
    };
}

function displayResults(a) {
    const div = document.getElementById('results');
    const decades = Object.keys(a.decadeDistribution).sort();
    const max = Math.max(...Object.values(a.decadeDistribution));

    let bars = '';
    for (const d of decades) {
        const pct = (a.decadeDistribution[d]/max)*100;
        const crown = parseInt(d) === a.dominantDecade ? 'ðŸ‘‘' : '';
        bars += `
        <div class="decade-bar">
            <div class="decade-name">${d}s</div>
            <div class="bar-container"><div class="bar-fill" style="width:${pct}%"></div></div>
            <div style="width:50px;text-align:right">${a.decadeDistribution[d]} ${crown}</div>
        </div>`;
    }

    div.innerHTML = `
        <div class="listening-age">
            <div>Your Listening Age</div>
            <div class="age-number">${a.listeningAge}</div>
            <div>You listen like someone from the ${a.dominantDecade}s!</div>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-label">Dominant Decade</div>
                <div class="stat-value">${a.dominantDecade}s</div>
            </div>

            <div class="stat-card">
                <div class="stat-label">Albums Analyzed</div>
                <div class="stat-value">${a.totalAlbums}</div>
            </div>

            <div class="stat-card">
                <div class="stat-label">Average Release Year</div>
                <div class="stat-value">${a.averageYear}</div>
            </div>

            <div class="stat-card">
                <div class="stat-label">Decade Distribution</div>
                ${bars}
            </div>
        </div>
    `;

    div.style.display = 'block';
}

document.getElementById('username').addEventListener('keypress', e => {
    if (e.key === 'Enter') calculateListeningAge();
});

async function calculateListeningAge() {
    const username = document.getElementById('username').value.trim();
    if (!username) {
        document.getElementById('error').textContent = "Please enter a username.";
        document.getElementById('error').style.display = 'block';
        return;
    }

    document.getElementById('calculate').disabled = true;
    document.getElementById('loading').style.display = 'block';
    document.getElementById('error').style.display = 'none';
    document.getElementById('results').style.display = 'none';

    try {
        updateProgress("Fetching your top albums...");
        const top = await fetchTopAlbums(username);

        updateProgress("Resolving album metadata...");
        const dated = await fetchAlbumDates(top, username);

        updateProgress("Calculating...");
        const result = analyzeListeningAge(dated);

        displayResults(result);
    } catch(err) {
        document.getElementById('error').textContent = err.message;
        document.getElementById('error').style.display = 'block';
    } finally {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('calculate').disabled = false;
        updateProgress("");
    }
}
</script>

</body>
</html>
